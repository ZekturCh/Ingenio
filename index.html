<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Generador de Tira de Fotos con Fondos Predefinidos</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #6e8efb, #a777e3);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      color: #333;
    }
    
    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    h1 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-size: 2.2rem;
    }
    
    .description {
      margin-bottom: 25px;
      color: #555;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.6;
    }
    
    .upload-container {
      background: #f8f9fa;
      border: 2px dashed #6c757d;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 20px;
      transition: all 0.3s;
    }
    
    .upload-container:hover {
      background: #e9ecef;
      border-color: #4e73df;
    }
    
    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    button {
      padding: 12px 25px;
      background: #4e73df;
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    button:hover {
      background: #2e59d9;
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    #btnDescargar {
      background: #1cc88a;
    }
    
    #btnDescargar:hover {
      background: #17a673;
    }
    
    .canvas-container {
      margin: 20px auto;
      width: 100%;
      overflow: auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      padding: 10px;
    }
    
    canvas {
      display: block;
      margin: 0 auto;
      background: #fff;
      border: 1px solid #ddd;
      max-width: 100%;
      height: auto;
    }
    
    .print-tips {
      margin-top: 25px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      text-align: left;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .print-tips h3 {
      margin-bottom: 10px;
      color: #2c3e50;
    }
    
    .print-tips ul {
      padding-left: 20px;
    }
    
    .print-tips li {
      margin-bottom: 8px;
      line-height: 1.5;
    }
    
    .thumbnail-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }
    
    .thumbnail {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #ddd;
    }
    
    .file-input-label {
      display: inline-block;
      padding: 12px 25px;
      background: #4e73df;
      color: white;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      margin-bottom: 15px;
    }
    
    .file-input-label:hover {
      background: #2e59d9;
    }
    
    input[type="file"] {
      display: none;
    }
    
    .status-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      background: #f8f9fa;
      padding: 10px 15px;
      border-radius: 50px;
      font-size: 14px;
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-loaded {
      background: #1cc88a;
    }
    
    .status-loading {
      background: #f6c23e;
    }
    
    .status-error {
      background: #e74a3b;
    }
    
    .printer-settings {
      background: #e8f4fd;
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
    }
    
    .printer-settings h3 {
      color: #2c3e50;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Generador de Tira de Fotos para Hiti P322W</h1>
    
    <p class="description">Sube 6 fotos para crear una tira de fotos optimizada para tu impresora Hiti P322W. El sistema cargará automáticamente los fondos predefinidos.</p>
    
    <div class="upload-container">
      <label for="fileInput" class="file-input-label">Seleccionar 6 Fotos</label>
      <input type="file" id="fileInput" accept="image/*" multiple>
      
      <div class="thumbnail-container" id="thumbnailContainer">
        <!-- Las miniaturas se mostrarán aquí -->
      </div>
    </div>

    <div class="status-container">
      <div class="status-item">
        <span class="status-indicator" id="statusFondoIndicator"></span>
        <span id="statusFondoText">Fondo: Cargando...</span>
      </div>
      <div class="status-item">
        <span class="status-indicator" id="statusSobreIndicator"></span>
        <span id="statusSobreText">Superposición: Cargando...</span>
      </div>
      <div class="status-item">
        <span class="status-indicator" id="statusFotosIndicator"></span>
        <span id="statusFotosText">Fotos: 0/6</span>
      </div>
    </div>
    
    <div class="controls">
      <button id="btnGenerar">Generar Tira</button>
      <button id="btnDescargar" disabled>Descargar</button>
    </div>
    
    <div class="canvas-container">
      <canvas id="canvas" width="1000" height="1800"></canvas>
    </div>
    
    <div class="print-tips">
      <h3>Consejos para imprimir en tu Hiti P322W:</h3>
      <ul>
        <li>Usa papel fotográfico de calidad para obtener los mejores resultados</li>
        <li>Configura la impresora con los márgenes al mínimo</li>
        <li>Selecciona "Escala real" o "Tamaño real" en opciones de impresión</li>
        <li>Desactiva cualquier opción de "Ajustar a página"</li>
        <li>Verifica que la orientación sea vertical</li>
        <li>Utiliza la máxima calidad de impresión disponible</li>
      </ul>
    </div>

    <div class="printer-settings">
      <h3>Configuración específica para Hiti P322W</h3>
      <p>Esta plantilla está optimizada a 1000x1800 píxeles para evitar el recorte del lado izquierdo en tu impresora. Las imágenes de fondo y superposición se cargan automáticamente desde la carpeta de la aplicación.</p>
    </div>
  </div>

  <script>
    // Tamaño del lienzo ajustado para Hiti P322W
    const CANVAS_W = 1000;
    const CANVAS_H = 1800;

    // Posiciones fijas para las fotos (ajustadas para el nuevo tamaño)
    const POSICIONES_MANUALES = [
      {x: 40, y: 315}, 
      {x: 40, y: 695},
      {x: 40, y: 1075},
      {x: 520, y: 315},
      {x: 520, y: 695},
      {x: 520, y: 1075}
    ];

    // Tamaño fijo de cada foto (ajustado para el nuevo tamaño)
    const ANCHO_FOTO = 430;
    const ALTO_FOTO = 350;

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = CANVAS_W;
    canvas.height = CANVAS_H;

    // Imágenes
    let imagenes = [];
    let imagenFondo = null;
    let imagenSobre = null;

    // Referencias a elementos UI
    const fileInput = document.getElementById('fileInput');
    const btnGenerar = document.getElementById('btnGenerar');
    const btnDescargar = document.getElementById('btnDescargar');
    const thumbnailContainer = document.getElementById('thumbnailContainer');
    const statusFondoIndicator = document.getElementById('statusFondoIndicator');
    const statusFondoText = document.getElementById('statusFondoText');
    const statusSobreIndicator = document.getElementById('statusSobreIndicator');
    const statusSobreText = document.getElementById('statusSobreText');
    const statusFotosIndicator = document.getElementById('statusFotosIndicator');
    const statusFotosText = document.getElementById('statusFotosText');

    // Cargar imágenes de fondo y superposición automáticamente
    function cargarImagenesAutomaticas() {
      // Cargar fondo
      imagenFondo = new Image();
      imagenFondo.onload = function() {
        statusFondoIndicator.className = 'status-indicator status-loaded';
        statusFondoText.textContent = 'Fondo: Cargado';
        console.log('Fondo cargado correctamente');
      };
      imagenFondo.onerror = function() {
        statusFondoIndicator.className = 'status-indicator status-error';
        statusFondoText.textContent = 'Fondo: Error al cargar';
        console.error('Error al cargar el fondo. Asegúrate de que fondo2.png está en la misma carpeta.');
        
        // Crear un fondo blanco como respaldo
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, CANVAS_W, CANVAS_H);
      };
      imagenFondo.crossOrigin = "anonymous";
      imagenFondo.src = 'fondo2.png';

      // Cargar superposición
      imagenSobre = new Image();
      imagenSobre.onload = function() {
        statusSobreIndicator.className = 'status-indicator status-loaded';
        statusSobreText.textContent = 'Superposición: Cargada';
        console.log('Superposición cargada correctamente');
      };
      imagenSobre.onerror = function() {
        statusSobreIndicator.className = 'status-indicator status-error';
        statusSobreText.textContent = 'Superposición: Error al cargar';
        console.error('Error al cargar la superposición. Asegúrate de que over.png está en la misma carpeta.');
      };
      imagenSobre.crossOrigin = "anonymous";
      imagenSobre.src = 'over.png';

      // Dibujar vista inicial
      dibujarVistaInicial();
    }

    // Dibujar vista inicial
    function dibujarVistaInicial() {
      // Fondo blanco
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, CANVAS_W, CANVAS_H);
      
      // Dibujar áreas para fotos (solo para visualización)
      ctx.fillStyle = 'rgba(78, 115, 223, 0.05)';
      POSICIONES_MANUALES.forEach(pos => {
        ctx.fillRect(pos.x, pos.y, ANCHO_FOTO, ALTO_FOTO);
      });
      
      // Dibujar texto de ejemplo
      ctx.fillStyle = '#333';
      ctx.font = '26px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('Generador de Tira de Fotos', CANVAS_W / 2, 150);
      ctx.font = '18px Arial';
      ctx.fillText('Selecciona 6 fotos para comenzar', CANVAS_W / 2, 190);
      ctx.fillText('Las imágenes de fondo se cargan automáticamente', CANVAS_W / 2, 225);
    }

    // Inicializar
    cargarImagenesAutomaticas();

    // Manejar la selección de archivos
    fileInput.addEventListener('change', function(e) {
      const files = Array.from(e.target.files);
      thumbnailContainer.innerHTML = '';
      
      if (files.length > 6) {
        alert('Solo puedes seleccionar hasta 6 fotos. Se usarán las primeras 6.');
      }
      
      // Actualizar estado
      const loadedCount = Math.min(files.length, 6);
      statusFotosIndicator.className = `status-indicator ${loadedCount > 0 ? 'status-loaded' : 'status-loading'}`;
      statusFotosText.textContent = `Fotos: ${loadedCount}/6`;
      
      // Habilitar/deshabilitar botones según la selección
      btnGenerar.disabled = files.length < 6;
      
      // Mostrar miniaturas
      files.slice(0, 6).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.classList.add('thumbnail');
          thumbnailContainer.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    // Generar la tira de fotos
    btnGenerar.addEventListener('click', generarTira);

    function generarTira() {
      const files = Array.from(fileInput.files).slice(0, 6);
      if (files.length < 6) {
        alert('Por favor, selecciona exactamente 6 fotos.');
        return;
      }

      imagenes = [];
      let imagenesCargadas = 0;

      files.forEach((file, i) => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            imagenes[i] = img;
            imagenesCargadas++;
            
            if (imagenesCargadas === 6) {
              render();
              btnDescargar.disabled = false;
            }
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    function render() {
      // Limpiar el canvas
      ctx.clearRect(0, 0, CANVAS_W, CANVAS_H);
      
      // Dibujar fondo (imagen cargada o blanco por defecto)
      if (imagenFondo && imagenFondo.complete && imagenFondo.naturalHeight !== 0) {
        ctx.drawImage(imagenFondo, 0, 0, CANVAS_W, CANVAS_H);
      } else {
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, CANVAS_W, CANVAS_H);
      }
      
      // Dibujar fotos
      for (let i = 0; i < 6; i++) {
        const pos = POSICIONES_MANUALES[i];
        if (imagenes[i]) {
          drawImageCover(ctx, imagenes[i], pos.x, pos.y, ANCHO_FOTO, ALTO_FOTO);
        }
      }
      
      // Dibujar superposición si está cargada
      if (imagenSobre && imagenSobre.complete && imagenSobre.naturalHeight !== 0) {
        ctx.drawImage(imagenSobre, 0, 0, CANVAS_W, CANVAS_H);
      }
    }

    function drawImageCover(ctx, img, dx, dy, dW, dH) {
      const sW = img.width;
      const sH = img.height;
      const srcAR = sW / sH;
      const dstAR = dW / dH;

      let sx, sy, sw, sh;
      if (srcAR > dstAR) {
        sh = sH;
        sw = sh * dstAR;
        sx = (sW - sw) / 2;
        sy = 0;
      } else {
        sw = sW;
        sh = sw / dstAR;
        sx = 0;
        sy = (sH - sh) / 2;
      }
      ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dW, dH);
    }

    // Descargar la imagen
    btnDescargar.addEventListener('click', descargarBlob);

    function descargarBlob() {
      // Crear un canvas temporal para la descarga
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      tempCanvas.width = CANVAS_W;
      tempCanvas.height = CANVAS_H;
      
      // Dibujar el fondo
      if (imagenFondo && imagenFondo.complete && imagenFondo.naturalHeight !== 0) {
        tempCtx.drawImage(imagenFondo, 0, 0, CANVAS_W, CANVAS_H);
      } else {
        tempCtx.fillStyle = '#fff';
        tempCtx.fillRect(0, 0, CANVAS_W, CANVAS_H);
      }
      
      // Dibujar las fotos
      for (let i = 0; i < 6; i++) {
        const pos = POSICIONES_MANUALES[i];
        if (imagenes[i]) {
          const img = imagenes[i];
          const sW = img.width;
          const sH = img.height;
          const srcAR = sW / sH;
          const dstAR = ANCHO_FOTO / ALTO_FOTO;

          let sx, sy, sw, sh;
          if (srcAR > dstAR) {
            sh = sH;
            sw = sh * dstAR;
            sx = (sW - sw) / 2;
            sy = 0;
          } else {
            sw = sW;
            sh = sw / dstAR;
            sx = 0;
            sy = (sH - sh) / 2;
          }
          tempCtx.drawImage(img, sx, sy, sw, sh, pos.x, pos.y, ANCHO_FOTO, ALTO_FOTO);
        }
      }
      
      // Dibujar la superposición
      if (imagenSobre && imagenSobre.complete && imagenSobre.naturalHeight !== 0) {
        tempCtx.drawImage(imagenSobre, 0, 0, CANVAS_W, CANVAS_H);
      }
      
      // Descargar
      tempCanvas.toBlob(function(blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tira-de-fotos.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 'image/png');
    }
  </script>
</body>
</html>
