<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Generador de Tira de Fotos Mejorado</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #6e8efb, #a777e3);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    h1 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-size: 2.2rem;
    }
    
    h2 {
      margin: 25px 0 15px;
      color: #3498db;
      font-size: 1.5rem;
      text-align: left;
      padding-bottom: 8px;
      border-bottom: 2px solid #eee;
    }
    
    .description {
      margin-bottom: 25px;
      color: #555;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.6;
    }
    
    .upload-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 25px;
    }
    
    @media (max-width: 768px) {
      .upload-section {
        grid-template-columns: 1fr;
      }
    }
    
    .upload-container {
      background: #f8f9fa;
      border: 2px dashed #6c757d;
      border-radius: 10px;
      padding: 20px;
      transition: all 0.3s;
    }
    
    .upload-container:hover {
      background: #e9ecef;
      border-color: #4e73df;
    }
    
    .upload-container h3 {
      margin-bottom: 15px;
      color: #2c3e50;
    }
    
    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 25px 0;
      flex-wrap: wrap;
    }
    
    button {
      padding: 12px 25px;
      background: #4e73df;
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    button:hover {
      background: #2e59d9;
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    #btnDescargar {
      background: #1cc88a;
    }
    
    #btnDescargar:hover {
      background: #17a673;
    }
    
    .canvas-container {
      margin: 20px auto;
      width: 100%;
      overflow: auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      padding: 15px;
    }
    
    canvas {
      display: block;
      margin: 0 auto;
      background: #fff;
      border: 1px solid #ddd;
      max-width: 100%;
      height: auto;
    }
    
    .print-tips {
      margin-top: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      text-align: left;
    }
    
    .print-tips h3 {
      margin-bottom: 15px;
      color: #2c3e50;
      text-align: center;
    }
    
    .print-tips ul {
      padding-left: 20px;
      columns: 2;
    }
    
    @media (max-width: 600px) {
      .print-tips ul {
        columns: 1;
      }
    }
    
    .print-tips li {
      margin-bottom: 10px;
      line-height: 1.5;
    }
    
    .thumbnail-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
    }
    
    .thumbnail {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #ddd;
    }
    
    .file-input-label {
      display: inline-block;
      padding: 12px 25px;
      background: #4e73df;
      color: white;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      margin: 10px 0;
    }
    
    .file-input-label:hover {
      background: #2e59d9;
    }
    
    input[type="file"] {
      display: none;
    }
    
    .image-preview {
      max-width: 200px;
      max-height: 150px;
      margin: 15px auto;
      border: 2px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-loaded {
      background: #1cc88a;
    }
    
    .status-pending {
      background: #f6c23e;
    }
    
    .status-missing {
      background: #e74a3b;
    }
    
    .printer-settings {
      background: #e8f4fd;
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
    }
    
    .printer-settings h3 {
      color: #2c3e50;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Generador de Tira de Fotos para Hiti P322W</h1>
    
    <p class="description">Sube 6 fotos, una imagen de fondo y una superposición para crear una tira de fotos optimizada para tu impresora Hiti P322W.</p>
    
    <div class="upload-section">
      <div class="upload-container">
        <h3>Fotos para la tira <span id="statusFotos"><span class="status-indicator status-pending"></span>0/6</span></h3>
        <label for="fileInputFotos" class="file-input-label">Seleccionar Fotos</label>
        <input type="file" id="fileInputFotos" accept="image/*" multiple>
        
        <div class="thumbnail-container" id="thumbnailContainer">
          <!-- Las miniaturas se mostrarán aquí -->
        </div>
      </div>
      
      <div class="upload-container">
        <h3>Imágenes de fondo y superposición</h3>
        
        <div style="margin-bottom: 20px;">
          <h4><span id="statusFondo"><span class="status-indicator status-pending"></span>Fondo</span></h4>
          <label for="fileInputFondo" class="file-input-label">Seleccionar Fondo</label>
          <input type="file" id="fileInputFondo" accept="image/*">
          <div class="image-preview">
            <img id="previewFondo" src="" alt="Vista previa del fondo">
          </div>
          <p><small>Si no seleccionas fondo, se usará uno predeterminado</small></p>
        </div>
        
        <div>
          <h4><span id="statusSobre"><span class="status-indicator status-pending"></span>Superposición</span></h4>
          <label for="fileInputSobre" class="file-input-label">Seleccionar Superposición</label>
          <input type="file" id="fileInputSobre" accept="image/*">
          <div class="image-preview">
            <img id="previewSobre" src="" alt="Vista previa de la superposición">
          </div>
          <p><small>Si no seleccionas superposición, se usará una predeterminada</small></p>
        </div>
      </div>
    </div>
    
    <div class="controls">
      <button id="btnGenerar">Generar Tira</button>
      <button id="btnDescargar" disabled>Descargar</button>
    </div>
    
    <div class="canvas-container">
      <canvas id="canvas" width="1181" height="1772"></canvas>
    </div>
    
    <div class="print-tips">
      <h3>Consejos para imprimir en tu Hiti P322W:</h3>
      <ul>
        <li>Usa papel fotográfico de calidad para obtener los mejores resultados</li>
        <li>Configura la impresora con los márgenes al mínimo</li>
        <li>Selecciona "Escala real" o "Tamaño real" en opciones de impresión</li>
        <li>Desactiva cualquier opción de "Ajustar a página"</li>
        <li>Verifica que la orientación sea vertical</li>
        <li>Utiliza la máxima calidad de impresión disponible</li>
        <li>Para mejores resultados, usa imágenes de 1181x1772 píxeles</li>
      </ul>
    </div>

    <div class="printer-settings">
      <h3>Configuración específica para Hiti P322W</h3>
      <p>Esta plantilla está optimizada para evitar el recorte de bordes en tu impresora. Hemos ajustado el área de impresión para que coincida con las especificaciones de la Hiti P322W.</p>
    </div>
  </div>

  <script>
    // Tamaño del lienzo
    const CANVAS_W = 1181;
    const CANVAS_H = 1772;

    // Posiciones fijas para las fotos (ligeramente ajustadas para la Hiti P322W)
    const POSICIONES_MANUALES = [
      {x: 60, y: 320},   // Ajustadas para evitar bordes recortados
      {x: 60, y: 710},
      {x: 60, y: 1100},
      {x: 640, y: 320},  // Ajustadas para evitar bordes recortados
      {x: 640, y: 710},
      {x: 640, y: 1100}
    ];

    // Tamaño fijo de cada foto (ligeramente reducido para la Hiti P322W)
    const ANCHO_FOTO = 480;
    const ALTO_FOTO = 350;

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = CANVAS_W;
    canvas.height = CANVAS_H;

    // Imágenes
    let imagenes = [];
    let imagenFondo = null;
    let imagenSobre = null;
    let imagenesCargadas = 0;

    // Referencias a elementos UI
    const fileInputFotos = document.getElementById('fileInputFotos');
    const fileInputFondo = document.getElementById('fileInputFondo');
    const fileInputSobre = document.getElementById('fileInputSobre');
    const btnGenerar = document.getElementById('btnGenerar');
    const btnDescargar = document.getElementById('btnDescargar');
    const thumbnailContainer = document.getElementById('thumbnailContainer');
    const previewFondo = document.getElementById('previewFondo');
    const previewSobre = document.getElementById('previewSobre');
    const statusFotos = document.getElementById('statusFotos');
    const statusFondo = document.getElementById('statusFondo');
    const statusSobre = document.getElementById('statusSobre');

    // Cargar imágenes predeterminadas
    function cargarImagenesPredeterminadas() {
      // Crear fondo predeterminado (transparente)
      const fondoDefault = new Image();
      fondoDefault.onload = function() {
        imagenFondo = fondoDefault;
        statusFondo.innerHTML = '<span class="status-indicator status-loaded"></span>Fondo (Predeterminado)';
      };
      // Fondo transparente en lugar del marco azul
      fondoDefault.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1181" height="1772"><rect width="100%" height="100%" fill="white"/></svg>';

      // Crear superposición predeterminada (transparente)
      const sobreDefault = new Image();
      sobreDefault.onload = function() {
        imagenSobre = sobreDefault;
        statusSobre.innerHTML = '<span class="status-indicator status-loaded"></span>Superposición (Predeterminada)';
      };
      // Superposición transparente en lugar del texto
      sobreDefault.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1181" height="1772"><rect width="100%" height="100%" fill="none"/></svg>';
    }

    // Dibujar vista previa inicial
    function dibujarVistaPrevia() {
      // Fondo blanco
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, CANVAS_W, CANVAS_H);
      
      // Dibujar áreas para fotos (solo para visualización)
      ctx.fillStyle = 'rgba(78, 115, 223, 0.05)';
      POSICIONES_MANUALES.forEach(pos => {
        ctx.fillRect(pos.x, pos.y, ANCHO_FOTO, ALTO_FOTO);
      });
      
      // Dibujar texto de ejemplo
      ctx.fillStyle = '#333';
      ctx.font = '30px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('Tira de Fotos - Vista previa', CANVAS_W / 2, 150);
      ctx.font = '20px Arial';
      ctx.fillText('Tus fotos aparecerán en los recuadros azules', CANVAS_W / 2, 200);
      ctx.fillText('Carga un fondo y una superposición para personalizar', CANVAS_W / 2, 240);
    }

    // Inicializar con vista previa
    cargarImagenesPredeterminadas();
    dibujarVistaPrevia();

    // Manejar la selección de archivos de fotos
    fileInputFotos.addEventListener('change', function(e) {
      const files = Array.from(e.target.files);
      thumbnailContainer.innerHTML = '';
      
      if (files.length > 6) {
        alert('Solo puedes seleccionar hasta 6 fotos. Se usarán las primeras 6.');
      }
      
      // Actualizar estado
      const loadedCount = Math.min(files.length, 6);
      statusFotos.innerHTML = `<span class="status-indicator ${loadedCount > 0 ? 'status-loaded' : 'status-pending'}"></span>${loadedCount}/6`;
      
      // Habilitar/deshabilitar botones según la selección
      btnGenerar.disabled = files.length === 0;
      
      // Mostrar miniaturas
      files.slice(0, 6).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.classList.add('thumbnail');
          thumbnailContainer.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    // Manejar la selección de fondo
    fileInputFondo.addEventListener('change', function(e) {
      if (e.target.files.length === 0) return;
      
      const file = e.target.files[0];
      const reader = new FileReader();
      
      reader.onload = function(e) {
        // Actualizar vista previa
        previewFondo.src = e.target.result;
        
        // Cargar imagen para el canvas
        const img = new Image();
        img.onload = function() {
          imagenFondo = img;
          statusFondo.innerHTML = '<span class="status-indicator status-loaded"></span>Fondo (Cargado)';
        };
        img.src = e.target.result;
      };
      
      reader.readAsDataURL(file);
    });

    // Manejar la selección de superposición
    fileInputSobre.addEventListener('change', function(e) {
      if (e.target.files.length === 0) return;
      
      const file = e.target.files[0];
      const reader = new FileReader();
      
      reader.onload = function(e) {
        // Actualizar vista previa
        previewSobre.src = e.target.result;
        
        // Cargar imagen para el canvas
        const img = new Image();
        img.onload = function() {
          imagenSobre = img;
          statusSobre.innerHTML = '<span class="status-indicator status-loaded"></span>Superposición (Cargada)';
        };
        img.src = e.target.result;
      };
      
      reader.readAsDataURL(file);
    });

    // Generar la tira de fotos
    btnGenerar.addEventListener('click', generarTira);

    function generarTira() {
      const files = Array.from(fileInputFotos.files).slice(0, 6);
      if (files.length < 6) {
        alert('Por favor, selecciona exactamente 6 fotos.');
        return;
      }

      imagenes = [];
      imagenesCargadas = 0;

      files.forEach((file, i) => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            imagenes[i] = img;
            imagenesCargadas++;
            
            if (imagenesCargadas === 6) {
              render();
              btnDescargar.disabled = false;
            }
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    function render() {
      // Limpiar el canvas
      ctx.clearRect(0, 0, CANVAS_W, CANVAS_H);
      
      // Dibujar fondo (blanco por defecto o imagen cargada)
      if (imagenFondo) {
        ctx.drawImage(imagenFondo, 0, 0, CANVAS_W, CANVAS_H);
      } else {
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, CANVAS_W, CANVAS_H);
      }
      
      // Dibujar fotos
      for (let i = 0; i < 6; i++) {
        const pos = POSICIONES_MANUALES[i];
        if (imagenes[i]) {
          drawImageCover(ctx, imagenes[i], pos.x, pos.y, ANCHO_FOTO, ALTO_FOTO);
        }
      }
      
      // Dibujar superposición si está cargada
      if (imagenSobre) {
        ctx.drawImage(imagenSobre, 0, 0, CANVAS_W, CANVAS_H);
      }
    }

    function drawImageCover(ctx, img, dx, dy, dW, dH) {
      const sW = img.width;
      const sH = img.height;
      const srcAR = sW / sH;
      const dstAR = dW / dH;

      let sx, sy, sw, sh;
      if (srcAR > dstAR) {
        sh = sH;
        sw = sh * dstAR;
        sx = (sW - sw) / 2;
        sy = 0;
      } else {
        sw = sW;
        sh = sw / dstAR;
        sx = 0;
        sy = (sH - sh) / 2;
      }
      ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dW, dH);
    }

    // Descargar la imagen
    btnDescargar.addEventListener('click', descargarBlob);

    function descargarBlob() {
      // Crear un canvas temporal para la descarga
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      tempCanvas.width = CANVAS_W;
      tempCanvas.height = CANVAS_H;
      
      // Dibujar el fondo
      if (imagenFondo) {
        tempCtx.drawImage(imagenFondo, 0, 0, CANVAS_W, CANVAS_H);
      } else {
        tempCtx.fillStyle = '#fff';
        tempCtx.fillRect(0, 0, CANVAS_W, CANVAS_H);
      }
      
      // Dibujar las fotos
      for (let i = 0; i < 6; i++) {
        const pos = POSICIONES_MANUALES[i];
        if (imagenes[i]) {
          const img = imagenes[i];
          const sW = img.width;
          const sH = img.height;
          const srcAR = sW / sH;
          const dstAR = ANCHO_FOTO / ALTO_FOTO;

          let sx, sy, sw, sh;
          if (srcAR > dstAR) {
            sh = sH;
            sw = sh * dstAR;
            sx = (sW - sw) / 2;
            sy = 0;
          } else {
            sw = sW;
            sh = sw / dstAR;
            sx = 0;
            sy = (sH - sh) / 2;
          }
          tempCtx.drawImage(img, sx, sy, sw, sh, pos.x, pos.y, ANCHO_FOTO, ALTO_FOTO);
        }
      }
      
      // Dibujar la superposición
      if (imagenSobre) {
        tempCtx.drawImage(imagenSobre, 0, 0, CANVAS_W, CANVAS_H);
      }
      
      // Descargar
      tempCanvas.toBlob(function(blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tira-de-fotos.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 'image/png');
    }
  </script>
</body>
</html>
